
from typing import Dict, Any
from telegram.ext import Application, CommandHandler, CallbackQueryHandler, MessageHandler, filters, ContextTypes
from telegram import InlineKeyboardButton, InlineKeyboardMarkup, ReplyKeyboardMarkup, KeyboardButton, Update, Contact

# Bot token
TOKEN = "7961055236:AAHoGcIwo91sHc12cV0VSCaWobYoRTgOrMc"

# User states and data
user_cart: Dict[int, Dict[str, int]] = {}

# Menu items
MENU_ITEMS = {
    'wings': {
        'name': 'üçó –ö—É—Ä–∏–Ω—ã–µ –∫—Ä—ã–ª—ã—à–∫–∏',
        'items': {
            'wings_6': {'name': '6 –∫—Ä—ã–ª—ã—à–µ–∫', 'price': 35000},
            'wings_12': {'name': '12 –∫—Ä—ã–ª—ã—à–µ–∫', 'price': 65000},
            'wings_24': {'name': '24 –∫—Ä—ã–ª—ã—à–∫–∞', 'price': 120000}
        }
    },
    'burgers': {
        'name': 'üçî –ë—É—Ä–≥–µ—Ä—ã',
        'items': {
            'twister': {'name': '–¢–≤–∏—Å—Ç–µ—Ä', 'price': 28000},
            'zinger': {'name': '–ó–∏–Ω–≥–µ—Ä', 'price': 32000},
            'big_box': {'name': '–ë–∏–≥ –ë–æ–∫—Å', 'price': 45000}
        }
    },
    'drinks': {
        'name': 'ü•§ –ù–∞–ø–∏—Ç–∫–∏',
        'items': {
            'cola': {'name': '–ö–æ–ª–∞', 'price': 8000},
            'fanta': {'name': '–§–∞–Ω—Ç–∞', 'price': 8000},
            'sprite': {'name': '–°–ø—Ä–∞–π—Ç', 'price': 8000}
        }
    }
}

def get_main_menu() -> ReplyKeyboardMarkup:
    """Create the main menu keyboard."""
    keyboard = [
        [KeyboardButton("üçó –ú–µ–Ω—é"), KeyboardButton("üõí –ö–æ—Ä–∑–∏–Ω–∞")],
        [KeyboardButton("üì± –ö–æ–Ω—Ç–∞–∫—Ç—ã"), KeyboardButton("‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏")]
    ]
    return ReplyKeyboardMarkup(keyboard, resize_keyboard=True)

async def start(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """Start the bot and show the welcome message."""
    welcome_text = """
üçó –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ KFC Uzbekistan Delivery!

–ú—ã —Ä–∞–¥—ã –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–æ–≤–∞—Ç—å –≤–∞—Å –≤ –Ω–∞—à–µ–º –±–æ—Ç–µ –¥–æ—Å—Ç–∞–≤–∫–∏. –ó–¥–µ—Å—å –≤—ã –º–æ–∂–µ—Ç–µ:
‚Ä¢ –ó–∞–∫–∞–∑–∞—Ç—å –ª—é–±–∏–º—ã–µ –±–ª—é–¥–∞ KFC
‚Ä¢ –û—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å —Å—Ç–∞—Ç—É—Å –∑–∞–∫–∞–∑–∞
‚Ä¢ –£–∑–Ω–∞—Ç—å –æ –Ω–∞—à–∏—Ö –∞–∫—Ü–∏—è—Ö

–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ –∏–∑ –º–µ–Ω—é –Ω–∏–∂–µ:
    """
    await update.message.reply_text(welcome_text, reply_markup=get_main_menu())

async def show_menu(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """Display the menu categories."""
    menu_text = "üçó –ù–∞—à–µ –º–µ–Ω—é:\n\n"
    keyboard = []

    for category_id, category in MENU_ITEMS.items():
        menu_text += f"{category['name']}\n"
        keyboard.append([InlineKeyboardButton(category['name'], callback_data=f"category_{category_id}")])

    keyboard.append([InlineKeyboardButton("‚óÄÔ∏è –ù–∞–∑–∞–¥", callback_data='back')])
    reply_markup = InlineKeyboardMarkup(keyboard)

    if update.callback_query:
        await update.callback_query.edit_message_text(menu_text, reply_markup=reply_markup)
    else:
        await update.message.reply_text(menu_text, reply_markup=reply_markup)

async def show_category(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """Show items in the selected category."""
    query = update.callback_query
    category_id = query.data.split('_')[1]

    if category_id not in MENU_ITEMS:
        await query.answer("–û—à–∏–±–∫–∞: –∫–∞—Ç–µ–≥–æ—Ä–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞!")
        return

    category = MENU_ITEMS[category_id]
    menu_text = f"{category['name']}:\n\n"
    keyboard = []

    for item_id, item in category['items'].items():
        menu_text += f"{item['name']} - {item['price']} —Å—É–º\n"
        keyboard.append([
            InlineKeyboardButton(f"‚ûï {item['name']}", callback_data=f"add_{item_id}"),
            InlineKeyboardButton(f"‚ûñ {item['name']}", callback_data=f"remove_{item_id}")
        ])

    keyboard.append([InlineKeyboardButton("‚óÄÔ∏è –ù–∞–∑–∞–¥", callback_data='menu')])
    reply_markup = InlineKeyboardMarkup(keyboard)
    await query.edit_message_text(menu_text, reply_markup=reply_markup)

async def add_to_cart(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """Add an item to the user's cart."""
    query = update.callback_query
    user_id = query.from_user.id
    item_id = query.data.split('_')[1]

    if user_id not in user_cart:
        user_cart[user_id] = {}

    user_cart[user_id][item_id] = user_cart[user_id].get(item_id, 0) + 1
    await query.answer("–¢–æ–≤–∞—Ä –¥–æ–±–∞–≤–ª–µ–Ω –≤ –∫–æ—Ä–∑–∏–Ω—É!")


async def remove_from_cart(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """Remove an item from the user's cart."""
    query = update.callback_query
    user_id = query.from_user.id
    item_id = query.data.split('_')[1]

    if user_id in user_cart and item_id in user_cart[user_id]:
        user_cart[user_id][item_id] -= 1
        if user_cart[user_id][item_id] <= 0:
            del user_cart[user_id][item_id]
        await query.answer("–¢–æ–≤–∞—Ä —É–¥–∞–ª–µ–Ω –∏–∑ –∫–æ—Ä–∑–∏–Ω—ã!")
    else:
        await query.answer("–¢–æ–≤–∞—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –∫–æ—Ä–∑–∏–Ω–µ!")

async def show_cart(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """Display the user's cart."""
    user_id = update.effective_user.id
    cart_text = "üõí –í–∞—à–∞ –∫–æ—Ä–∑–∏–Ω–∞:\n\n"
    total = 0

    if user_id in user_cart and user_cart[user_id]:
        for item_id, quantity in user_cart[user_id].items():
            for category in MENU_ITEMS.values():
                if item_id in category['items']:
                    item = category['items'][item_id]
                    cart_text += f"{item['name']} x{quantity} - {item['price'] * quantity} —Å—É–º\n"
                    total += item['price'] * quantity
                    break

        cart_text += f"\nüí∞ –ò—Ç–æ–≥–æ: {total} —Å—É–º"
        keyboard = [
            [InlineKeyboardButton("‚úÖ –û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑", callback_data='checkout')],
            [InlineKeyboardButton("‚ùå –û—á–∏—Å—Ç–∏—Ç—å –∫–æ—Ä–∑–∏–Ω—É", callback_data='clear_cart')],
            [InlineKeyboardButton("‚óÄÔ∏è –ù–∞–∑–∞–¥", callback_data='back')]
        ]
    else:
        cart_text = "üõí –í–∞—à–∞ –∫–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞"
        keyboard = [[InlineKeyboardButton("‚óÄÔ∏è –ù–∞–∑–∞–¥", callback_data='back')]]

    reply_markup = InlineKeyboardMarkup(keyboard)

    if update.callback_query:
        await update.callback_query.edit_message_text(cart_text, reply_markup=reply_markup)
    else:
        await update.message.reply_text(cart_text, reply_markup=reply_markup)

async def contacts(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """Display contact information."""
    contacts_text = """
üì± –ù–∞—à–∏ –∫–æ–Ω—Ç–∞–∫—Ç—ã:

‚òéÔ∏è Call-—Ü–µ–Ω—Ç—Ä: +998 (78) 129-70-00
üìç –ê–¥—Ä–µ—Å–∞ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–æ–≤:
‚Ä¢ –¢–∞—à–∫–µ–Ω—Ç, —É–ª. –ù–∞–≤–æ–∏, 1
‚Ä¢ –¢–∞—à–∫–µ–Ω—Ç, —É–ª. –ê–º–∏—Ä–∞ –¢–µ–º—É—Ä–∞, 15
‚Ä¢ –°–∞–º–∞—Ä–∫–∞–Ω–¥, —É–ª. –†–µ–≥–∏—Å—Ç–∞–Ω, 5

‚è∞ –í—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã: 10:00 - 23:00
    """
    keyboard = [[InlineKeyboardButton("‚óÄÔ∏è –ù–∞–∑–∞–¥", callback_data='back')]]
    reply_markup = InlineKeyboardMarkup(keyboard)

    if update.callback_query:
        await update.callback_query.edit_message_text(contacts_text, reply_markup=reply_markup)
    else:
        await update.message.reply_text(contacts_text, reply_markup=reply_markup)

async def settings(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """Display settings options."""
    settings_text = """
‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏:

–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:
    """
    keyboard = [
        [InlineKeyboardButton("üåê –Ø–∑—ã–∫", callback_data='language')],
        [InlineKeyboardButton("üì± –ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞", callback_data='phone')],
        [InlineKeyboardButton("‚óÄÔ∏è –ù–∞–∑–∞–¥", callback_data='back')]
    ]
    reply_markup = InlineKeyboardMarkup(keyboard)

    if update.callback_query:
        await update.callback_query.edit_message_text(settings_text, reply_markup=reply_markup)
    else:
        await update.message.reply_text(settings_text, reply_markup=reply_markup)

async def handle_message(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """Handle incoming messages and route to appropriate functions."""
    text = update.message.text

    if text == "üçó –ú–µ–Ω—é":
        await show_menu(update, context)
    elif text == "üõí –ö–æ—Ä–∑–∏–Ω–∞":
        await show_cart(update, context)
    elif text == "üì± –ö–æ–Ω—Ç–∞–∫—Ç—ã":
        await contacts(update, context)
    elif text == "‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏":
        await settings(update, context)
    else:
        await update.message.reply_text("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫–∏ –º–µ–Ω—é.")

async def button(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """Handle button presses."""
    query = update.callback_query
    await query.answer()


# Route based on the callback data
    if query.data == 'menu':
        await show_menu(update, context)
    elif query.data.startswith('category_'):
        await show_category(update, context)
    elif query.data.startswith('add_'):
        await add_to_cart(update, context)
    elif query.data.startswith('remove_'):
        await remove_from_cart(update, context)
    elif query.data == 'cart':
        await show_cart(update, context)
    elif query.data == 'contacts':
        await contacts(update, context)
    elif query.data == 'settings':
        await settings(update, context)
    elif query.data == 'back':
        await start(update, context)
    elif query.data == 'clear_cart':
        user_id = query.from_user.id
        user_cart[user_id] = {}
        await show_cart(update, context)
    elif query.data == 'checkout':
        await query.edit_message_text("–î–ª—è –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è –∑–∞–∫–∞–∑–∞, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–ø—Ä–∞–≤—å—Ç–µ –≤–∞—à –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞.")
    elif query.data == 'phone':
        await query.message.reply_text(
            "üì± –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–ø—Ä–∞–≤—å—Ç–µ —Å–≤–æ–π –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞, –∏—Å–ø–æ–ª—å–∑—É—è –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ.",
            reply_markup=ReplyKeyboardMarkup(
                [[KeyboardButton("üì≤ –û—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–æ–º–µ—Ä", request_contact=True)]],
                resize_keyboard=True,
                one_time_keyboard=True
            )
        )
    elif query.data == 'language':
        keyboard = [
            [InlineKeyboardButton("üá∑üá∫ –†—É—Å—Å–∫–∏–π", callback_data='lang_ru')],
            [InlineKeyboardButton("üá∫üáø O‚Äòzbekcha", callback_data='lang_uz')],
            [InlineKeyboardButton("‚óÄÔ∏è –ù–∞–∑–∞–¥", callback_data='settings')]
        ]
        await query.edit_message_text("üåê –í—ã–±–µ—Ä–∏—Ç–µ —è–∑—ã–∫:", reply_markup=InlineKeyboardMarkup(keyboard))
    elif query.data == 'lang_ru':
        await query.answer("–Ø–∑—ã–∫ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω: –†—É—Å—Å–∫–∏–π")
        await settings(update, context)
    elif query.data == 'lang_uz':
        await query.answer("Til o‚Äòrnatildi: O‚Äòzbekcha")
        await settings(update, context)

async def handle_contact(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """Handle user contact information."""
    contact: Contact = update.message.contact
    if contact:
        await update.message.reply_text(
            f"‚úÖ –í–∞—à –∑–∞–∫–∞–∑ –ø—Ä–∏–Ω—è—Ç! –í–∞—à –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞: {contact.phone_number}",
            reply_markup=get_main_menu()
        )
    else:
        await update.message.reply_text("‚ùóÔ∏è –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–ø—Ä–∞–≤—å—Ç–µ –∫–æ–Ω—Ç–∞–∫—Ç —Å –ø–æ–º–æ—â—å—é –∫–Ω–æ–ø–∫–∏.")

def main() -> None:
    """Run the bot."""
    application = Application.builder().token(TOKEN).build()

    application.add_handler(CommandHandler("start", start))
    application.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, handle_message))
    application.add_handler(CallbackQueryHandler(button))
    application.add_handler(MessageHandler(filters.CONTACT, handle_contact))

    print("ü§ñ Bot is running...")
    application.run_polling(allowed_updates=Update.ALL_TYPES)

if name == 'main':
    main()
